---
import { getCollection } from 'astro:content';
const { currentPath = '', version = '' } = Astro.props;
const isZh = currentPath.startsWith('/zh/');
const all = await getCollection('docs');

// Split language collections
const enDocs = all.filter(d => !d.id.includes('.zh.'));
const zhDocsRaw = all.filter(d => d.id.includes('.zh.'));
// Normalize zh docs by stripping trailing 'zh' once for canonical route display
const zhDocs = zhDocsRaw.map(d => ({...d, canonicalSlug: d.slug.replace(/zh$/, '') }));
const activeDocs = isZh ? zhDocs : enDocs;

// Normalize slug (strip .zh)
function normSlug(d){
  if (isZh) return (d.canonicalSlug || d.slug).replace(/\.zh$/,'');
  return d.slug;
}

// Desired ordered groups (curated logical learning path)
const orderedGroups = isZh
  ? ['新闻','概述','指南','核心功能','可靠性','示例','企业']
  : ['News','Overview','Guide','Core Features','Reliability','Recipes','Enterprise'];

// Build map: group -> items
const map = new Map();
for (const d of activeDocs) {
  const grp = d.data.group || (isZh ? '其它' : 'Other');
  if (!map.has(grp)) map.set(grp, []);
  map.get(grp).push(d);
}

// Sort items per group: order asc, title asc
for (const [k, arr] of map.entries()) {
  arr.sort((a,b)=> (a.data.order ?? 0) - (b.data.order ?? 0) || a.data.title.localeCompare(b.data.title));
}

// Compose final list honoring orderedGroups first, then remaining groups alphabetically
const remaining = Array.from(map.keys()).filter(g => !orderedGroups.includes(g)).sort((a,b)=> a.localeCompare(b));
const finalGroups = [...orderedGroups, ...remaining].filter(g => map.has(g));

function isActive(slug){
  const s = slug === 'intro' ? 'intro' : slug;
  const base = isZh ? '/zh/docs/' : '/docs/';
  return currentPath === base + s || currentPath === base + s + '/' || (s==='intro' && (currentPath===base || currentPath===base.slice(0,-1)));
}
---

<aside class="sidebar" id="docs-sidebar" role="navigation" aria-label="Documentation navigation">
  <div class="logo-row">
    <a href={isZh ? '/zh/' : '/'} class="brand">Ailib</a><button
      id="sidebar-close"
      aria-label="Close"
      class="close-btn">×</button
    >
  </div>
  {finalGroups.map(groupName => {
    const items = map.get(groupName) || [];
    return (
      <div class="group">
        <button class="group-head" type="button" data-collapse>
          <span>{groupName}</span>
        </button>
        <ul>
          {items.map(d => {
            const slug = normSlug(d);
            return (
              <li class={isActive(slug) ? 'active' : ''}>
                <a href={(isZh ? '/zh/docs/' : '/docs/') + slug}>
                  {d.data.title}
                  {d.data.status && <span class={`badge-status ${d.data.status}`}>{d.data.status}</span>}
                </a>
              </li>
            );
          })}
        </ul>
      </div>
    );
  })}
  <div class="version">v{version}</div>
  <button id="sidebar-backdrop" aria-hidden="true"></button>
</aside>
<button id="sidebar-toggle" class="sidebar-toggle" aria-label="Open navigation">☰</button>
<script>
  const sidebar = document.getElementById('docs-sidebar');
  const toggleBtn = document.getElementById('sidebar-toggle');
  const closeBtn = document.getElementById('sidebar-close');
  const backdrop = document.getElementById('sidebar-backdrop');
  const STORAGE_KEY = 'docs.sidebar.state.v1';
  const GROUP_KEY_PREFIX = 'docs.group.';

  function loadState() {
    try {
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');
    } catch {
      return {};
    }
  }
  function saveState(state) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }
  const state = loadState();
  if (state.open) sidebar.classList.add('open');

  function open() {
    sidebar.classList.add('open');
    state.open = true;
    saveState(state);
  }
  function close() {
    sidebar.classList.remove('open');
    state.open = false;
    saveState(state);
  }
  toggleBtn.addEventListener('click', () =>
    sidebar.classList.contains('open') ? close() : open()
  );
  closeBtn.addEventListener('click', close);
  backdrop.addEventListener('click', close);

  window.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && sidebar.classList.contains('open')) close();
  });

  const groups = sidebar.querySelectorAll('.group');
  groups.forEach((g) => {
    const head = g.querySelector('[data-collapse]');
    const name = head?.textContent?.trim() || '';
    const key = GROUP_KEY_PREFIX + name;
    if (localStorage.getItem(key) === 'collapsed') g.classList.add('collapsed');
    head.addEventListener('click', () => {
      const collapsed = g.classList.toggle('collapsed');
      localStorage.setItem(key, collapsed ? 'collapsed' : 'open');
    });
  });

  // Close on link click in mobile mode
  sidebar.querySelectorAll('a').forEach((a) => {
    a.addEventListener('click', () => {
      if (matchMedia('(max-width:960px)').matches) close();
    });
  });
</script>
<style>
  .sidebar {
    position: sticky;
    top: 70px;
    max-height: calc(100vh - 80px);
    overflow: auto;
    width: 250px;
    padding: 12px 10px 40px;
    border-right: 1px solid var(--border);
    background: var(--bg-alt);
    box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    z-index: 10;
  }
  .logo-row {
    padding: 4px 8px 10px;
    font-weight: 600;
  }
  .brand {
    color: var(--text);
    text-decoration: none;
    font-size: 18px;
  }
  .close-btn {
    margin-left: auto;
    background: transparent;
    border: 0;
    font-size: 24px;
    line-height: 1;
    cursor: pointer;
    color: var(--text-dim);
    display: none;
  }
  .close-btn:hover {
    color: var(--text);
  }
  .group {
    margin-top: 14px;
  }
  .group-head {
    width: 100%;
    background: transparent;
    border: 0;
    text-align: left;
    padding: 6px 8px;
    font: inherit;
    font-size: 14px;
    font-weight: bold;
    letter-spacing: 0.5px;
    text-transform: uppercase;
    color: var(--text-dim);
    display: flex;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.2s ease;
    border-radius: 4px;
  }
  .group-head:hover {
    background: rgba(93, 139, 255, 0.05);
    color: var(--accent);
  }
  .group.collapsed ul {
    display: none;
  }
  ul {
    list-style: none;
    margin: 4px 0 0;
    padding: 0;
  }
  li a {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px 6px 20px;
    border-radius: 6px;
    color: var(--text-dim);
    font-size: 14px;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  li a:hover {
    background: rgba(93, 139, 255, 0.1);
    color: var(--accent);
    transform: translateX(2px);
    transition: all 0.2s ease;
  }
  li.active > a {
    background: var(--accent);
    color: #fff;
  }
  .badge-status {
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    padding: 2px 4px;
    border-radius: 4px;
    background: #2a3442;
    color: #b5c6e5;
  }
  .badge-status.stable {
    background: #1d4d2f;
    color: #9ee3b4;
  }
  .badge-status.partial {
    background: #5a4708;
    color: #ffdb85;
  }
  .badge-status.planned {
    background: #3a3a3a;
    color: #c8c8c8;
  }
  .version {
    margin-top: 28px;
    font-size: 12px;
    color: var(--text-dim);
    padding: 8px 10px;
    border-top: 1px solid var(--border);
  }
  .sidebar-toggle {
    position: fixed;
    left: 14px;
    top: 14px;
    z-index: 90;
    background: var(--accent);
    color: #fff;
    border: 0;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 18px;
    cursor: pointer;
    display: none;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
  #sidebar-backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.25);
    border: 0;
    padding: 0;
    margin: 0;
  }
  /* Desktop styles - ensure sidebar is visible */
  .sidebar {
    display: block !important;
  }
  
  @media (min-width: 961px) {
    .sidebar {
      display: block !important;
    }
    .sidebar-toggle {
      display: none;
    }
  }

  @media (max-width: 960px) {
    .sidebar-toggle {
      display: block;
    }
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      bottom: 0;
      transform: translateX(-101%);
      transition:
        0.25s transform,
        0.25s box-shadow;
      z-index: 120;
      max-height: none;
      width: 270px;
      border-right: 1px solid var(--border);
      box-shadow: 0 0 0 rgba(0, 0, 0, 0);
    }
    .sidebar.open {
      transform: translateX(0);
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
    }
    #sidebar-backdrop {
      display: block;
      opacity: 0;
      transition: 0.25s opacity;
    }
    .sidebar.open + #sidebar-backdrop {
      opacity: 1;
      pointer-events: auto;
    }
    #sidebar-backdrop {
      pointer-events: none;
    }
    .close-btn {
      display: block;
    }
  }
</style>
