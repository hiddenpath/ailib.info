---
import '../styles/global.css';
import Sidebar from '../components/Sidebar.astro';
import BuildMeta from '../components/BuildMeta.astro';
import { getCollection } from 'astro:content';
// Load version dynamically from package.json so docs always show current package version
// Astro supports importing JSON directly at build time.
import pkg from '../../package.json';
const version = pkg.version as string;
// Support both frontmatter (from old static .astro pages) and docTitle prop (dynamic collection pages)
// Astro.props holds passed props when used via dynamic [slug] route.
// Fallback order: explicit docTitle -> frontmatter.title -> default.
// We also forward frontmatter when provided for potential meta usage later.
// @ts-ignore
const { frontmatter, url, docTitle } = { ...(Astro as any), ...(Astro.props || {}) };

// Build ordered flat list for prev/next (only for doc pages with a slug path starting /docs)
let nav: { slug: string; title: string; order: number; group: string }[] = [];
try {
  const coll = await getCollection('docs');
  for (const e of coll) {
    nav.push({
      slug: e.slug,
      title: e.data.title,
      order: e.data.order ?? 0,
      group: e.data.group || 'Other',
    });
  }
  nav.sort((a, b) => {
    // group alphabetical first, then numeric order, then title
    if (a.group !== b.group) return a.group.localeCompare(b.group);
    if (a.order !== b.order) return a.order - b.order;
    return a.title.localeCompare(b.title);
  });
} catch (e) {
  // collection not available (e.g., index page) – ignore
}

let prev: (typeof nav)[number] | undefined;
let next: (typeof nav)[number] | undefined;
if (frontmatter?.title) {
  const idx = nav.findIndex(
    (n) =>
      '/docs/' + n.slug === url.pathname ||
      (n.slug === 'intro' && (url.pathname === '/docs' || url.pathname === '/docs/'))
  );
  if (idx !== -1) {
    prev = idx > 0 ? nav[idx - 1] : undefined;
    next = idx < nav.length - 1 ? nav[idx + 1] : undefined;
  }
}
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{docTitle || frontmatter?.title || 'Ailib Docs'}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" href="/favicon.svg" />
    <script>
      document.documentElement.dataset.theme = 'light';
    </script>
  </head>
  <body data-docs>
    <header class="site-header">
      <div class="inner">
        <a href="/" class="brand" aria-label="ai-lib home">
          <span class="logo-mark" aria-hidden="true">λ</span>
          <span class="brand-text">Ailib</span>
        </a>
        <nav class="nav-actions">
          <a href="/docs" class="nav-link active">Docs</a>
          <div class="lang-switch-top">
            <a href="/">English</a>
          </div>
          <a
            class="gh"
            href="https://github.com/hiddenpath/ai-lib"
            target="_blank"
            rel="noopener"
            aria-label="GitHub">★</a
          >
        </nav>
      </div>
    </header>
    <div class="docs-shell">
      <Sidebar currentPath={url.pathname} version={version} />
      <main class="doc-main">
        <article class="doc-article">
          <slot />
          {
            (prev || next) && (
              <nav class="prev-next">
                {prev ? (
                  <a class="prev" href={`/docs/${prev.slug}`}>
                    ← {prev.title}
                  </a>
                ) : (
                  <span />
                )}
                {next ? (
                  <a class="next" href={`/docs/${next.slug}`}>
                    {next.title} →
                  </a>
                ) : (
                  <span />
                )}
              </nav>
            )
          }
        </article>
      </main>
      <BuildMeta />
    </div>
  </body>
</html>
<style>
  /* Import header styles */
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    backdrop-filter: blur(14px);
    background: rgba(10, 12, 16, 0.72);
    border-bottom: 1px solid rgba(60, 70, 84, 0.4);
    z-index: 50;
  }
  [data-theme='light'] .site-header {
    background: rgba(255, 255, 255, 0.72);
    border-color: rgba(180, 190, 205, 0.6);
  }
  .site-header .inner {
    max-width: 1120px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 18px;
    color: var(--text);
    text-decoration: none;
  }
  .logo-mark {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, var(--accent), #7ca8ff);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #fff;
    border-radius: 8px;
    box-shadow:
      0 2px 6px -2px var(--accent-glow),
      0 0 0 1px rgba(255, 255, 255, 0.04) inset;
  }
  .nav-actions {
    display: flex;
    align-items: center;
    gap: 18px;
  }
  .nav-link {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 6px;
    transition: background-color 0.2s;
  }
  .nav-link:hover, .nav-link.active {
    background: var(--bg-alt);
    color: var(--accent);
  }
  .lang-switch-top a {
    font-size: 14px;
  }
  .gh {
    font-size: 18px;
    text-decoration: none;
  }

  body[data-docs] {
    display: block;
    padding-top: 70px; /* Add space for fixed header */
  }
  .docs-shell {
    display: flex;
    align-items: flex-start;
    min-height: calc(100vh - 70px);
  }
  .doc-main {
    flex: 1;
    padding: 40px 46px 120px;
    min-width: 0;
    max-width: 800px; /* Limit content width for better readability */
  }
  .doc-article h1 {
    margin-top: 0;
    font-size: 40px;
    line-height: 1.2;
    margin-bottom: 24px;
  }
  .doc-article h2 {
    font-size: 28px;
    margin-top: 48px;
    margin-bottom: 16px;
    line-height: 1.3;
  }
  .doc-article h3 {
    font-size: 22px;
    margin-top: 32px;
    margin-bottom: 12px;
    line-height: 1.4;
  }
  .doc-article p {
    line-height: 1.7;
    margin-bottom: 16px;
  }
  .doc-article ul, .doc-article ol {
    line-height: 1.7;
    margin-bottom: 16px;
  }
  .doc-article li {
    margin-bottom: 8px;
  }
  .doc-article pre {
    margin: 20px 0;
    font-size: 14px;
    line-height: 1.5;
  }
  .doc-article code {
    font-size: 14px;
    padding: 2px 6px;
  }
  .prev-next {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 60px;
    padding-top: 30px;
    border-top: 1px solid var(--border);
    font-size: 14px;
  }
  .prev-next a {
    text-decoration: none;
    color: var(--text-dim);
    padding: 8px 12px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    transition:
      0.15s background,
      color;
  }
  .prev-next a:hover {
    background: var(--accent);
    color: #fff;
  }
  @media (max-width: 960px) {
    .docs-shell {
      display: block;
    }
    .doc-main {
      padding: 90px 22px 120px;
    }
  }
</style>
