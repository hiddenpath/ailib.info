---
import '../styles/global.css';
import Sidebar from '../components/Sidebar.astro';
import BuildMeta from '../components/BuildMeta.astro';
import { getCollection } from 'astro:content';
import pkg from '../../package.json';
const version = pkg.version as string;
// @ts-ignore
const { frontmatter, url, docTitle } = { ...(Astro as any), ...(Astro.props || {}) };

const isZh = url.pathname.startsWith('/zh/');
const basePath = isZh ? '/zh/docs/' : '/docs/';

// Build prev/next from docs content collection (group -> order -> title)
let nav: { slug: string; title: string; order: number; group: string }[] = [];
try {
  const docs = await getCollection('docs');
  for (const d of docs) {
    nav.push({
      slug: d.slug,
      title: d.data.title,
      order: d.data.order ?? 0,
      group: d.data.group || 'Other'
    });
  }
  nav.sort((a,b)=>{
    if(a.group !== b.group) return a.group.localeCompare(b.group);
    if(a.order !== b.order) return a.order - b.order;
    return a.title.localeCompare(b.title);
  });
} catch {}

let prev: (typeof nav)[number] | undefined;
let next: (typeof nav)[number] | undefined;
if (frontmatter?.title) {
  const idx = nav.findIndex(
    (n) =>
      basePath + n.slug === url.pathname ||
      (n.slug === 'intro' && (url.pathname === basePath.slice(0, -1) || url.pathname === basePath))
  );
  if (idx !== -1) {
    prev = idx > 0 ? nav[idx - 1] : undefined;
    next = idx < nav.length - 1 ? nav[idx + 1] : undefined;
  }
}
---

<html lang={isZh ? 'zh' : 'en'}>
  <head>
    <meta charset="utf-8" />
  <title>{docTitle || frontmatter?.title || (isZh ? 'Ailib 文档' : 'Ailib Docs')}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <link rel="icon" href="/favicon.svg" />
    <script>
      document.documentElement.dataset.theme = 'light';
    </script>
  </head>
  <body data-docs>
    <header class="site-header">
      <div class="inner">
        <a href={isZh ? '/zh/' : '/'} class="brand" aria-label="ai-lib home">
          <span class="logo-mark" aria-hidden="true">λ</span>
          <span class="brand-text">Ailib</span>
        </a>
        <nav class="nav-actions">
          <a href={isZh ? '/zh/docs/intro' : '/docs/intro'} class="nav-link dev-ref-btn">
            {isZh ? '开发者参考' : 'Developer Reference'}
          </a>
          <a href="#contact" class="nav-link">{isZh ? '联系' : 'Contact'}</a>
          <div class="lang-switch-top">
            {isZh ? <a href="/docs/intro">English</a> : <a href="/zh/docs/intro">中文</a>}
          </div>
          <a
            class="gh"
            href="https://github.com/hiddenpath/ai-lib"
            target="_blank"
            rel="noopener"
            aria-label="GitHub">★</a
          >
        </nav>
      </div>
    </header>
    <div class="docs-shell">
      <Sidebar currentPath={url.pathname} version={version} />
      <main class="doc-main">
        <article class="doc-article">
          <slot />
          {
            (prev || next) && (
              <nav class="prev-next">
                {prev ? (
                  <a class="prev" href={`${basePath}${prev.slug}`}>
                    ← {prev.title}
                  </a>
                ) : (
                  <span />
                )}
                {next ? (
                  <a class="next" href={`${basePath}${next.slug}`}>
                    {next.title} →
                  </a>
                ) : (
                  <span />
                )}
              </nav>
            )
          }
        </article>
      </main>
      <BuildMeta />
    </div>
    <!-- Global contact modal (for docs pages) -->
    <div id="contact-modal" class="modal" aria-hidden="true">
      <button class="modal-backdrop" aria-hidden="true" onclick="closeContactModal()"></button>
      <div class="modal-dialog" role="dialog" aria-modal="true" aria-labelledby="contact-title" onclick="event.stopPropagation()">
        <button class="modal-close" aria-label="Close" onclick="closeContactModal()">×</button>
        <h3 id="contact-title">{isZh ? '联系 ai-lib 团队' : 'Contact ai-lib Team'}</h3>
        <p class="dim">{isZh ? '请填写以下信息，我们通常 2–3 个工作日内回复。' : 'Please fill in the information below. We usually respond within 2–3 business days.'}</p>
        <form method="POST" action="https://formsubmit.co/walex_98@msn.com">
          <input type="hidden" name="_subject" value="ai-lib Website Contact" />
          <input type="hidden" name="_captcha" value="false" />
          <input type="hidden" name="_template" value="table" />
          <div class="row">
            <div class="col">
              <label>{isZh ? '姓名' : 'Name'}</label>
              <input required name="name" placeholder={isZh ? '姓名' : 'Your name'} />
            </div>
            <div class="col">
              <label>Email</label>
              <input required type="email" name="email" placeholder="you@company.com" />
            </div>
          </div>
          <div class="row">
            <div class="col">
              <label>{isZh ? '公司 / 组织' : 'Company / Org'}</label>
              <input name="company" placeholder="Acme Corp" />
            </div>
            <div class="col">
              <label>{isZh ? '预计用例' : 'Intended Use Case'}</label>
              <input name="use_case" placeholder={isZh ? '路由/成本/推理等' : 'Routing/Cost/Reasoning'} />
            </div>
          </div>
          <div class="row">
            <div class="col full">
              <label>{isZh ? '需求与时间表' : 'Needs & Timeline'}</label>
              <textarea name="details" rows="4" placeholder={isZh ? 'Q4 上线，需可靠性策略...' : 'Prod in Q4, need reliability strategy...'}></textarea>
            </div>
          </div>
          <div class="actions">
            <button class="button" type="submit">{isZh ? '发送' : 'Send'}</button>
          </div>
        </form>
      </div>
    </div>
    <script>
      // Early attach without waiting for any other script
      (function(){
        function ensureFns(){
          if (window.openContactModal) return; // already set by home page or earlier
          window.openContactModal = function(){
            const m = document.getElementById('contact-modal');
            if(!m){ location.hash='contact'; return; }
            m.setAttribute('aria-hidden','false');
            document.body.style.overflow='hidden';
            const first = m.querySelector('input, textarea, button');
            if(first) setTimeout(()=> first.focus(),30);
          };
          window.closeContactModal = function(){
            const m = document.getElementById('contact-modal');
            if(!m) return;
            m.setAttribute('aria-hidden','true');
            document.body.style.overflow='';
          };
        }
        ensureFns();
        // Hash open
        if (location.hash === '#contact') {
          requestAnimationFrame(()=> window.openContactModal());
        }
        // Delegate clicks
        document.addEventListener('click',(e)=>{
          const t = e.target instanceof Element ? e.target : null;
          const a = t ? t.closest('a,button') : null;
            if(!a) return;
            const href = a.getAttribute('href')||'';
            if(href === '#contact' || href.endsWith('#contact') || a.classList.contains('contact-link')){
              e.preventDefault();
              window.openContactModal();
            }
        }, { passive:false });
        document.addEventListener('keydown', (e)=> {
          if(e.key==='Escape'){ const m=document.getElementById('contact-modal'); if(m && m.getAttribute('aria-hidden')==='false') window.closeContactModal(); }
        });
      })();
    </script>
  </body>
</html>
<style>
  /* Import header styles */
  .site-header {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    backdrop-filter: blur(14px);
    background: rgba(10, 12, 16, 0.72);
    border-bottom: 1px solid rgba(60, 70, 84, 0.4);
    z-index: 50;
  }
  [data-theme='light'] .site-header {
    background: rgba(255, 255, 255, 0.72);
    border-color: rgba(180, 190, 205, 0.6);
  }
  .site-header .inner {
    max-width: 1120px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 20px;
  }
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 18px;
    color: var(--text);
    text-decoration: none;
  }
  .logo-mark {
    width: 28px;
    height: 28px;
    background: linear-gradient(135deg, var(--accent), #7ca8ff);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    color: #fff;
    border-radius: 8px;
    box-shadow:
      0 2px 6px -2px var(--accent-glow),
      0 0 0 1px rgba(255, 255, 255, 0.04) inset;
  }
  .nav-actions {
    display: flex;
    align-items: center;
    gap: 18px;
  }
  .nav-link {
    font-size: 14px;
    font-weight: 500;
    color: var(--text);
    text-decoration: none;
    padding: 6px 12px;
    border-radius: 6px;
    transition: background-color 0.2s;
  }
  .nav-link:hover, .nav-link.active {
    background: var(--bg-alt);
    color: var(--accent);
  }
  .lang-switch-top a {
    font-size: 14px;
  }
  .gh {
    font-size: 18px;
    text-decoration: none;
  }

  body[data-docs] {
    display: block;
    padding-top: 70px; /* Add space for fixed header */
  }
  .docs-shell {
    display: flex;
    align-items: flex-start;
    min-height: calc(100vh - 70px);
  }
  .doc-main {
    flex: 1;
    padding: 40px 46px 120px;
    min-width: 0;
    max-width: 800px; /* Limit content width for better readability */
  }
  .doc-article h1 {
    margin-top: 0;
    font-size: 40px;
    line-height: 1.2;
    margin-bottom: 24px;
  }
  .doc-article h2 {
    font-size: 28px;
    margin-top: 48px;
    margin-bottom: 16px;
    line-height: 1.3;
  }
  .doc-article h3 {
    font-size: 22px;
    margin-top: 32px;
    margin-bottom: 12px;
    line-height: 1.4;
  }
  .doc-article p {
    line-height: 1.7;
    margin-bottom: 16px;
    text-indent: 2em;
  }
  .doc-article ul, .doc-article ol {
    line-height: 1.7;
    margin-bottom: 16px;
    padding-left: 2em;
  }
  .doc-article li {
    margin-bottom: 8px;
  }
  .doc-article pre {
    margin: 20px 0;
    font-size: 14px;
    line-height: 1.5;
  }
  .doc-article code {
    font-size: 14px;
    padding: 2px 6px;
  }
  .prev-next {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 60px;
    padding-top: 30px;
    border-top: 1px solid var(--border);
    font-size: 14px;
  }
  .prev-next a {
    text-decoration: none;
    color: var(--text-dim);
    padding: 8px 12px;
    background: var(--bg-alt);
    border: 1px solid var(--border);
    border-radius: 6px;
    transition:
      0.15s background,
      color;
  }
  .prev-next a:hover {
    background: var(--accent);
    color: #fff;
  }
  @media (max-width: 960px) {
    .docs-shell {
      display: block;
    }
    .doc-main {
      padding: 90px 22px 120px;
    }
  }
  /* Contact modal (docs) reuse styles */
  .modal[aria-hidden="true"] { display: none; }
  .modal { position: fixed; inset: 0; z-index: 300; display: grid; place-items: center; }
  .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); border:0; }
  .modal-dialog { position: relative; width: min(680px, calc(100% - 28px)); border:1px solid var(--border); background: var(--bg); border-radius:16px; padding:22px 22px 18px; box-shadow:0 16px 48px rgba(0,0,0,.35); animation: modalIn .18s ease-out; }
  @keyframes modalIn { from { transform: translateY(8px); opacity:.85 } to { transform: translateY(0); opacity:1 } }
  .modal-close { position:absolute; top:10px; right:12px; border:0; background:transparent; font-size:20px; color: var(--text-dim); cursor:pointer; }
  .modal-close:hover { color: var(--text); }
  .row { display:flex; gap:12px; margin-top:10px; }
  .col { flex:1; min-width:220px; display:flex; flex-direction:column; gap:6px; }
  .col.full { min-width:100%; }
  .actions { display:flex; justify-content:flex-end; margin-top:14px; }
</style>
